variables:
  FLAGS: "-d --error-trace"
env:
  HOME: "/home/ralsina"

tasks:
  build:
    default: true
    dependencies:
      - src
      - shard.lock
      - shard.yml
      - Hacefile.yml
    outputs:
      - bin/hace
    commands: |
      shards build {{FLAGS}}

  build-release:
    phony: true
    always_run: true
    default: false
    commands: |
      hace build FLAGS="--release"
  install:
    default: false
    phony: true
    always_run: true
    dependencies:
      - bin/hace
    commands: |
      rm ${HOME}/.local/bin/hace
      cp bin/hace ${HOME}/.local/bin/hace

  test:
    default: false
    dependencies:
      - src
      - spec
      - shard.lock
      - shard.yml
    commands: |
      crystal spec -v --error-trace
    phony: true
    always_run: true

  mutation:
    default: false
    dependencies:
      - src
      - spec
      - shard.lock
      - shard.yml
    commands: |
      bin/crytic test -s src/hace.cr
    phony: true

  coverage:
    default: false
    dependencies:
      - src
      - spec
      - shard.lock
      - shard.yml
    commands: |
      shards install
      crystal build -o bin/run_tests src/run_tests.cr
      rm -rf coverage/
      mkdir coverage
      kcov --clean --include-path=./src coverage ./bin/run_tests
    outputs:
      - coverage/index.html

  lint:
    default: false
    dependencies:
      - src
      - spec
      - shard.lock
      - shard.yml
    commands: |
      crystal tool format src/*.cr spec/*.cr
      bin/ameba --all --fix
    always_run: true
    phony: true

  docs:
    dependencies:
      - src
      - shard.lock
      - shard.yml
      - README.md
    commands: |
      crystal docs
    outputs:
      - docs/index.html

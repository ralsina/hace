variables:
  FLAGS: "-d --error-trace -Dpreview_mt"
  NAME: "hace"

tasks:
  build:
    description: "Build the hace binary in debug mode"
    default: true
    dependencies:
      - src
      - shard.lock
      - shard.yml
      - Hacefile.yml
    outputs:
      - bin/{{NAME}}
    commands: |
      shards build {{FLAGS}}

  get-deps:
    description: "Install Crystal dependencies using shards"
    dependencies:
      - shard.yml
    outputs:
      - shard.lock
    commands: |
      shards install

  build-release:
    description: "Build hace binary in release mode with optimizations"
    phony: true
    always_run: true
    commands: |
      hace build FLAGS="--release"

  install:
    description: "Install hace binary to user's local bin directory"
    phony: true
    always_run: true
    dependencies:
      - bin/hace
    commands: |
      rm ${HOME}/.local/bin/hace
      cp bin/hace ${HOME}/.local/bin/hace

  static:
    description: "Build statically linked binaries for Linux (amd64 and arm64)"
    outputs:
      - bin/hace-static-linux-amd64
      - bin/hace-static-linux-arm64
    commands: |
      hace clean
      ./build_static.sh

  test:
    description: "Run the test suite with Crystal spec"
    dependencies:
      - src
      - spec
      - shard.lock
      - shard.yml
    commands: |
      crystal spec -v --error-trace
    phony: true
    always_run: true

  mutation:
    description: "Run mutation testing using Crytic to verify code quality"
    always_run: true
    dependencies:
      - src
      - spec
      - shard.lock
      - shard.yml
    commands: |
      bin/crytic test -s src/hace.cr
    phony: true

  coverage:
    description: "Generate test coverage report using kcov"
    dependencies:
      - src
      - spec
      - shard.lock
      - shard.yml
    commands: |
      shards install
      crystal build -o bin/run_tests src/run_tests.cr
      rm -rf coverage/
      mkdir coverage
      kcov --clean --include-path=./src ${PWD}/coverage ./bin/run_tests
    outputs:
      - coverage/index.html

  lint:
    description: "Format code and run Ameba linter with auto-fix"
    dependencies:
      - src
      - spec
      - shard.lock
      - shard.yml
    commands: |
      crystal tool format src/*.cr spec/*.cr
      bin/ameba --fix
    always_run: true
    phony: true

  docs:
    description: "Build user documentation using mdbook"
    dependencies:
      - docs/src
      - docs/src/*.md
      - docs/src/**/*.md
      - docs/book.toml
      - README.md
    commands: |
      cd docs && mdbook build
    outputs:
      - docs/book/index.html

  docs-serve:
    description: "Serve user documentation locally with live reload"
    dependencies:
      - docs/src
      - docs/src/*.md
      - docs/src/**/*.md
      - docs/book.toml
    commands: |
      cd docs && mdbook serve
    phony: true
    always_run: true

  user-docs-deploy:
    description: "Deploy user documentation to production server"
    dependencies:
      - docs/book
    commands: |
      rsync -avz --delete docs/book/ root@rocky:/data/stacks/web/websites/hace.ralsina.me/
    phony: true

  pre-commit:
    description: "Install git pre-commit hooks for code quality checks"
    default: true
    outputs:
      - .git/hooks/commit-msg
      - .git/hooks/pre-commit
    dependencies:
      - .pre-commit-config.yaml
    commands: |
      pre-commit install --hook-type commit-msg
      pre-commit install

  release:
    description: "Create a new GitHub release with version bump and assets"
    phony: true
    always_run: true
    dependencies:
      - bin/hace
      - do_release.sh
    commands: |
      ./do_release.sh

  release-check:
    description: "Check if the environment is ready for release"
    phony: true
    always_run: true
    commands: |
      echo "Checking release environment..."

      # Check required tools
      command -v git >/dev/null 2>&1 || { echo "❌ git is required but not installed."; exit 1; }
      command -v gh >/dev/null 2>&1 || { echo "❌ gh CLI is required but not installed."; exit 1; }
      command -v git-cliff >/dev/null 2>&1 || { echo "❌ git-cliff is required but not installed."; exit 1; }

      # Check git repo status
      if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo "❌ Error: Not in a git repository"
        exit 1
      fi

      # Check for uncommitted changes, but ignore certain files
      if ! git diff-index --quiet HEAD --; then
        # Get list of modified files
        modified_files=$(git diff-index --name-only HEAD --)

        # Check if any important files are modified
        important_files=false
        for file in $modified_files; do
          case "$file" in
            .claude/settings.local.json|spec/testcases/*/results/*|*.log)
              echo "ℹ️  Ignoring modified file: $file"
              ;;
            *)
              echo "❌ Error: Working directory has uncommitted changes in: $file"
              echo "   Please commit or stash these changes before releasing."
              important_files=true
              ;;
          esac
        done

        if [ "$important_files" = true ]; then
          exit 1
        fi
      fi

      # Check hace binary
      if [ ! -f "bin/hace" ]; then
        echo "❌ Error: bin/hace not found. Please run 'hace build' first."
        exit 1
      fi

      echo "✅ Release environment is ready!"
      echo "Next version will be: $(git cliff --bumped-version |cut -dv -f2)"

  release-dry-run:
    description: "Test release process without actually publishing"
    phony: true
    always_run: true
    dependencies:
      - bin/hace
      - release-check
    commands: |
      echo "Running release dry-run..."

      PKGNAME=$(basename "$PWD")
      VERSION=$(git cliff --bumped-version |cut -dv -f2)

      echo "Would release: $PKGNAME v$VERSION"
      echo "Would update shard.yml version to: $VERSION"
      echo "Would run: bin/hace lint test"
      echo "Would create changelog with git-cliff"
      echo "Would commit: bump: Release v$VERSION"
      echo "Would create tag: v$VERSION"
      echo "Would build static binaries for amd64 and arm64"
      echo "Would create GitHub release with assets"

      if [ -f "./do_aur.sh" ]; then
        echo "Would update AUR package"
      else
        echo "Would skip AUR update (do_aur.sh not found)"
      fi

      echo "Would deploy documentation"
      echo ""
      echo "✅ Dry-run completed successfully!"

  clean:
    description: "Remove all build artifacts and generated files"
    phony: true
    always_run: true
    commands: |
      rm -rf shard.lock bin lib
